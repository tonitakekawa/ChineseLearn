<!DOCTYPE html>
<html>
<head>
  <title>éŸ³å£°ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
</head>
<body>
  <h1>ãŠé¡Œã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼</h1>
  <button id="load-odai">ğŸ¯ ãŠé¡Œã‚’ã‚‚ã‚‰ã†</button>
  <p id="odai">...</p>
  <p id="odai-pinyin">ï¼ˆãƒ”ãƒ³ã‚¤ãƒ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>
  
  <button id="play-tts">ğŸ—£ï¸ ç™ºéŸ³ã‚’èã</button>
  <audio id="tts-audio" controls style="display:none;"></audio>

  <button id="record">ğŸ¤ éŒ²éŸ³ã™ã‚‹</button>
  <p id="result">ï¼ˆèªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</p>

  <script>
    const odaiElem = document.getElementById("odai");
    const resultElem = document.getElementById("result");
    const recordBtn = document.getElementById("record");
    const loadOdaiBtn = document.getElementById("load-odai");

    let mediaRecorder, audioChunks = [];

    loadOdaiBtn.onclick = async () => {
      const res = await fetch("http://localhost:5000/odai");
      const json = await res.json();
      odaiElem.textContent = json.text;
      document.getElementById("odai-pinyin").textContent = json.pinyin;
    };

    document.getElementById("play-tts").onclick = async () => {
    const text = document.getElementById("odai").textContent.trim();
    const res = await fetch("http://localhost:5000/tts", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ text })
    });

    if (!res.ok) {
      alert("TTSå–å¾—å¤±æ•—ï¼");
      return;
    }

    const blob = await res.blob();
    const audioURL = URL.createObjectURL(blob);
    const audioElem = document.getElementById("tts-audio");
    audioElem.src = audioURL;
    audioElem.style.display = "block";
    audioElem.play();
  };

    recordBtn.onclick = async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.textContent = "â¹ï¸ åœæ­¢";
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: "audio/webm" });
          const formData = new FormData();
          formData.append("audio", blob, "audio.webm");

          const res = await fetch("http://localhost:5000/stt", {
            method: "POST",
            body: formData
          });
          const json = await res.json();
          resultElem.textContent = "ğŸ“ èªè­˜çµæœ: " + json.text;
          resultElem.textContent += "\nğŸ“š ãƒ”ãƒ³ã‚¤ãƒ³: " + json.pinyin;

          recordBtn.textContent = "ğŸ¤ éŒ²éŸ³ã™ã‚‹";
        };
      } else {
        mediaRecorder.stop();
      }
    };
  </script>
</body>
</html>
